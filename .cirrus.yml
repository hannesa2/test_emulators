task:
  name: Test (x86)
  container:
    image: cirrusci/flutter:latest
    cpu: 4
    memory: 10G
    kvm: true
  pub_cache:
    folder: ~/.pub-cache
  matrix:
    - name: x86
      env:
        GOO: default
        matrix:
          - ABI: x86
          - ABI: x86_64
        matrix:
          - API: 28
          - API: 27
    - name: ARM
      env:
        matrix:
          - GOO: default
          - GOO: google_apis
        matrix:
          - ABI: armeabi-v7a
        matrix:
          - API: 25
          - API: 24
  allow_failures: "$API$GOO$ABI" == "25defaultarmeabi-v7a" || "$API$GOO$ABI" == "24defaultarmeabi-v7a"
  install_emulator_script: sdkmanager --update && sdkmanager "system-images;android-$API;$GOO;$ABI"
  create_emulator_script:
    - echo no | avdmanager --verbose create avd --force -n test -k "system-images;android-$API;$GOO;$ABI"
  start_emulator_background_script:
    - sudo chown cirrus:cirrus /dev/kvm
    - $ANDROID_HOME/emulator/emulator-headless -version
    - $ANDROID_HOME/emulator/emulator-headless -avd test -no-audio -no-window
  wait_for_emulator_script:
    - ./script/android-wait-for-emulator.sh
  doctor_script: flutter doctor -v
  test_script:
    - export PATH="$PATH":"$HOME/.pub-cache/bin"
    - cd flutter_app
    - flutter drive lib/main.dart